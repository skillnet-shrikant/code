$class=mff.loader.MffSettlementFailureGeneratorTask
$scope=global

# Flag to turn on/off task
enable=true

taskName=Settlement Failure Generator

# Email Configs
notificationEmailList=pventrapragada@dminc.com
notificationEmailFromAddress=no.reply@fleetfarm.com
disableEmail=false
runServer=localhost
feedDataSource=/atg/dynamo/service/jdbc/OMSJTDataSource
#itemsShippedButNotSettledQuery=select * from ATG_OMS.mff_nosettlement_records
#itemsWithNoAuthCodeQuery=select * from ATG_OMS.mff_noauthcode_records
#countShippedButNotSettled=select count(*) from ATG_OMS.mff_nosettlement_records
#countWithNoAuthCode=select count(*) from ATG_OMS.mff_noauthcode_records
itemsShippedButNotSettledQuery=select invc.*,ordr.submitted_date,paygrp.state,invoice.last_extract_date from atg_oms.dcspp_order ordr inner join atg_oms.mff_order mffordr on mffordr.order_id=ordr.order_id inner join (select mi.order_number, sum(mip.amount) as amount from atg_oms.mff_invoice mi, atg_oms.mff_invoice_rel_inv_payment relp, atg_oms.mff_invoice_payment mip where trunc(last_extract_date) = trunc(sysdate-1) and mi.invoice_id=relp.invoice_id and relp.payment_id=mip.payment_id group by mi.order_number minus select os.order_number, sum(os.amount) as amount from atg_oms.oms_settlement os where trunc(os.settle_date) = trunc(sysdate - 1) and os.settlement_type=1 group by os.order_number)invc on mffordr.order_number=invc.order_number inner join atg_oms.dcspp_pay_group paygrp on paygrp.order_ref=ordr.order_id inner join atg_oms.mff_invoice invoice on invoice.order_number=invc.order_number where trunc(invoice.last_extract_date) = trunc(sysdate-1) and invc.amount > 0
itemsWithNoAuthCodeQuery=select paygrp.*,ordr.submitted_date,mffordr.order_number from atg_oms.dcspp_order ordr inner join atg_oms.mff_order mffordr on mffordr.order_id=ordr.order_id  inner join(select dpp.order_ref,dpp.amount_debited, dpp.state,accs.auth_code from atg_oms.dcspp_pay_status dps, atg_oms.aci_credit_card_status accs, atg_oms.dcspp_debit_status dbs, atg_oms.dcspp_pay_group dpp where dps.status_id=accs.status_id and dps.trans_success=1 and accs.auth_code is null and dbs.payment_group_id=dpp.payment_group_id and dbs.debit_status=dps.status_id)paygrp on paygrp.order_ref=ordr.order_id
countShippedButNotSettled=select count(*) from atg_oms.dcspp_order ordr inner join atg_oms.mff_order mffordr on mffordr.order_id=ordr.order_id inner join (select mi.order_number, sum(mip.amount) as amount from atg_oms.mff_invoice mi, atg_oms.mff_invoice_rel_inv_payment relp, atg_oms.mff_invoice_payment mip where trunc(last_extract_date) = trunc(sysdate-1) and mi.invoice_id=relp.invoice_id and relp.payment_id=mip.payment_id group by mi.order_number minus select os.order_number, sum(os.amount) as amount from atg_oms.oms_settlement os where trunc(os.settle_date) = trunc(sysdate - 1) and os.settlement_type=1 group by os.order_number)invc on mffordr.order_number=invc.order_number inner join atg_oms.dcspp_pay_group paygrp on paygrp.order_ref=ordr.order_id inner join atg_oms.mff_invoice invoice on invoice.order_number=invc.order_number where trunc(invoice.last_extract_date) = trunc(sysdate-1) and invc.amount > 0
countWithNoAuthCode=select count(*) from atg_oms.dcspp_order ordr inner join atg_oms.mff_order mffordr on mffordr.order_id=ordr.order_id  inner join(select dpp.order_ref,dpp.amount_debited, dpp.state,accs.auth_code from atg_oms.dcspp_pay_status dps, atg_oms.aci_credit_card_status accs, atg_oms.dcspp_debit_status dbs, atg_oms.dcspp_pay_group dpp where dps.status_id=accs.status_id and dps.trans_success=1 and accs.auth_code is null and dbs.payment_group_id=dpp.payment_group_id and dbs.debit_status=dps.status_id)paygrp on paygrp.order_ref=ordr.order_id
storedProcName={call mff_settlement_failures.run()}
queryTimeout=300