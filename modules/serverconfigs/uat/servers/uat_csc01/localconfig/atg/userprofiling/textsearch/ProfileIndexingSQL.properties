oracle=SELECT ID, CREATION_DATE, LAST_MODIFIED_DATE, TOKENS FROM ( SELECT u.id AS ID , u.REGISTRATION_DATE AS CREATION_DATE , u.REGISTRATION_DATE AS REGISTRATION_DATE , u.LASTACTIVITY_DATE AS LASTACTIVITY_DATE , u.LASTPWDUPDATE AS LASTPWDUPDATE , spm.LAST_MODIFIED_DATE AS LAST_MODIFIED_DATE , token_data.tokens AS TOKENS FROM dps_user u LEFT OUTER JOIN srch_profile_modified spm ON (u.id = spm.id) LEFT OUTER JOIN ( SELECT ID, LISTAGG(TOKENS, '' '') WITHIN GROUP(ORDER BY TOKENS) AS TOKENS FROM ( SELECT u.id , ''pfid''  || u.id || '' '' || ''pflg'' || u.login || '' '' || ''pffn'' || u.first_name || '' '' || ''pfln'' || u.last_name || '' '' || ''pfem'' || u.email || '' '' || NVL2(u.realm_id, ''pfrm'' || u.realm_id || '' '', ''pfrm'' || ''dft'' || '' '') AS tokens FROM dps_user u UNION SELECT u.id , NVL2(c.postal_code, ''pfpc'' || REGEXP_REPLACE(c.postal_code, ''[^A-Za-z0-9]'') || '' '','''') || NVL2( c.phone_number, ''pfpn'' || REGEXP_REPLACE(c.phone_number, ''[^0-9]'') || '' '', '''') AS tokens FROM dps_user u LEFT OUTER JOIN dps_user_address ud ON (u.id = ud.id) LEFT OUTER JOIN dps_contact_info c ON (ud.shipping_addr_id = c.id) UNION SELECT u.id , NVL2(cb.postal_code, ''pfpc'' || REGEXP_REPLACE(cb.postal_code, ''[^A-Za-z0-9]'') || '' '','''') || NVL2( cb.phone_number, ''pfpn'' || REGEXP_REPLACE(cb.phone_number, ''[^0-9]''), '''') AS tokens FROM dps_user u LEFT OUTER JOIN dps_other_addr od     ON (u.id = od.user_id) LEFT OUTER JOIN dps_contact_info  cb  ON (od.address_id = cb.id) UNION SELECT u.id , NVL2(cp.postal_code, ''pfpc'' || REGEXP_REPLACE(cp.postal_code, ''[^A-Za-z0-9]'') || '' '','''') || NVL2( cp.phone_number, ''pfpn'' || REGEXP_REPLACE(cp.phone_number, ''[^0-9]''), '''') AS tokens FROM dps_user u LEFT OUTER JOIN dps_user_address ud   ON (u.id = ud.id) LEFT OUTER JOIN dps_contact_info  cp  ON (ud.billing_addr_id = cp.id) ) GROUP BY ID ) token_data ON u.ID = token_data.id ) all_data WHERE 1=1

